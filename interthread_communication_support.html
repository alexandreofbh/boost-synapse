<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN'
'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
	<meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
	<title>interthread communication support</title>
	<link href='reno.css' type='text/css' rel='stylesheet'/>
</head>
<body>
<div class="body-0">
<div class="body-1">
<div class="body-2">
<div>
<h1><a href="index.html">Boost Synapse</a></h1>
</div>
<!-- Copyright (c) 2015 Emil Dotchevski and Reverge Studios, Inc. -->
<!-- Distributed under the Boost Software License, Version 1.0. (See accompanying -->
<!-- file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt) -->
<div class="RenoIncludeDIV"><div class="RenoAutoDIV"><h3>Interthread Communication Support</h3>
</div>
<p><i><span class="RenoLink"><a href="index.html">Boost Synapse</a></span></i> can be used to implement interthread communication using <span class="RenoLink"><a href="Signal.html">Signals</a></span>. The data structures created by <i><span class="RenoLink"><a href="connect.html">connect</a></span></i> (or <i><span class="RenoLink"><a href="translate.html">translate</a></span></i>) use thread-local storage, so by default calling <i><span class="RenoLink"><a href="emit.html">emit</a></span></i> will call only functions connected by the calling thread (and will not return until all such functions have been called in order, or one of them throws.)</p>
<p>The following diagram shows the connections created (by calls to <i><span class="RenoLink"><a href="connect.html">connect</a></span>&lt;S&gt;</i>) in a single thread for a given signal type <i>S</i>, each connecting an emitter to a function. When <i><span class="RenoLink"><a href="emit.html">emit</a></span>&lt;S&gt;(e1,arg,...)</i> is called, all functions connected (for <i>S</i>) to the given emitter <i>e1</i> are called (in the order in which the connections were created):</p>
<img class="fig" src="fig1.png" alt="Thread-local operation" />
<p>However, it is also possible for any thread to request to receive all signals emitted by other threads, by creating its own <i>thread_local_queue</i> object using <i><span class="RenoLink"><a href="create_thread_local_queue.html">create_thread_local_queue</a></span></i>.</p>
<p>In this case, <b>in addition</b> to the behavior described above, <i><span class="RenoLink"><a href="emit.html">emit</a></span>&lt;S&gt;(e1,arg,...)</i> will capture its arguments (depending on the signature of <i>S</i>) and queue them into the <i>thread_local_queue</i> object created by any thread <b>other</b> than the calling thread. Each such thread must <i><span class="RenoLink"><a href="poll.html">poll</a></span></i> its own <i>thread_local_queue</i> regularly; this "emits" the queued objects locally and removes them from the queue (note that <i><span class="RenoLink"><a href="poll.html">poll</a></span></i> is not given an emitter or a signal type, it emits locally all queued objects, regardless of signal type or emitter).</p>
<p>This is illustrated by the following diagram:</p>
<img class="fig" src="fig2.png" alt="Thread-local operation" />
<p>A typical use case for this system is to update user interface objects with data generated by one or multiple worker threads. This way, the user interface objects themselves need not be thread-safe, because they will be updated only synchronously, at the time <i><span class="RenoLink"><a href="poll.html">poll</a></span></i> is called.</p>
<h4>Warning:</h4>
<p>Special care must be taken to ensure that any objects referred to by arguments passed to <i><span class="RenoLink"><a href="emit.html">emit</a></span></i> will remain valid until the time any other threads <i><span class="RenoLink"><a href="poll.html">poll</a></span></i> their <i>thread_local_queues</i>. For example, the following code is incorrect in the presence of <i>thread_local_queues</i>:</p>
<pre>typedef struct my_signal_(*my_signal)( int * );

void
emit_my_signal( int x )
    {
    <span class="RenoLink"><a href="emit.html">emit</a></span>&lt;my_signal&gt;(&amp;x); //Undefined behavior in the presence of thread_local_queues!
    }</pre>
<p>The problem is that the address of <i>x</i> may be queued into other threads' queues, and since <i>x</i> is local to <i>emit_my_signal</i>, it may be destroyed by the time these threads call <i><span class="RenoLink"><a href="poll.html">poll</a></span></i>.</p>
<h3>Using <i>thread_local_queue</i> objects to asynchronously schedule synchronous function execution</h3>
<p>The <i><span class="RenoLink"><a href="post.html">post</a></span></i> function can be used to queue into a <i>thread_local_queue</i> arbitrary functions for execution at the time <i><span class="RenoLink"><a href="poll.html">poll</a></span></i> is called to emit queued signals. This feature allows critical worker threads to minimize the amount of time they consume by offloading expensive non-critical computations to another, non-critical thread. This also removes the need for synchronization, since the queued functions are executed synchronously in the thread that owns the <i>thread_local_queue</i> object.</p>
</div><div class="RenoAutoDIV"><div class="RenoHR"><hr/></div>
See also: <span class="RenoPageList"><a href="index.html">Boost Synapse</a>&nbsp;| <a href="create_thread_local_queue.html">create_thread_local_queue</a>&nbsp;| <a href="poll.html">poll</a>&nbsp;| <a href="Tutorial.html">Tutorial</a></span>
</div>
<!-- Copyright (c) 2008-2013 Emil Dotchevski and Reverge Studios, Inc. -->
<!-- Distributed under the Boost Software License, Version 1.0. (See accompanying -->
<!-- file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt) -->
<div id="footer">
<p>
<a class="logo" href="http://jigsaw.w3.org/css-validator/check/referer"><img class="logo_pic" src="valid-css.png" alt="Valid CSS" height="31" width="88"/></a>
<a class="logo" href="http://validator.w3.org/check?uri=referer"><img class="logo_pic" src="valid-xhtml.png" alt="Valid XHTML 1.0" height="31" width="88"/></a>
<small>Copyright (c) 2015 by Emil Dotchevski and Reverge Studios, Inc.<br/>
Distributed under the <a href="http://www.boost.org/LICENSE_1_0.txt">Boost Software License, Version 1.0</a>.</small>
</p>
</div>
</div>
</div>
</div>
</body>
</html>
